- hosts:
  - mfdp.local
  become: false
  gather_facts: false
  collections: sviridov.dataprotector

  tasks:
    - name: 0 - Gather user facts
      mfdp_facts:
        gather_subset: users

    - name: 0 - Assert that root DP user is present
      assert:
        that: '"root|*|{{ ansible_host }}" in ansible_facts["dataprotector_users"].keys()'

    - name: 1.1 - Add user
      mfdp_users:
        name: win_user
        dp_groups: admin
        os_group: domain1
        client: client.company.com
        type: windows
      register: user_added

    - name: 1.1 - Assert that module result is changed
      assert:
        that: user_added is changed

    - name: 1.2 - Add user again
      mfdp_users:
        name: win_user
        dp_groups: admin
        os_group: domain1
        client: client.company.com
        type: windows
        description: "My test user"
      register: user_added

    - name: 1.2 - Assert that module result is not changed
      assert:
        that: user_added is not changed

    - name: 1.3 - Gather user facts again
      mfdp_facts:
        gather_subset: users

    - name: 1.3 - Assert that added user is present
      assert:
        that: '"win_user|domain1|client.company.com" in ansible_facts["dataprotector_users"].keys()'

    - name: 1.3 - Assert that added user is correct
      assert:
        that:
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["name"] = "win_user"'
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["dp_groups"] = "admin"'
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["os_group"] = "domain1"'
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["client"] = "client.company.com"'
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["type"] = "windows"'
          - 'ansible_facts["dataprotector_users"]["win_user|domain1|client.company.com"]["description"] = "My test user"'